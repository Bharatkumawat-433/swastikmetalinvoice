<!DOCTYPE html>
<html>
<head>
    <title>Swastik Metal Invoice</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            font-size: 14px;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .invoice-container {
            width: 800px;
            margin: 20px auto;
            padding: 15px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        td, th {
            border: 1px solid #000;
            padding: 8px;
            vertical-align: top;
            text-align: left;
        }
        .header-section table, .buyer-seller-section table {
            width: 100%;
        }
        .header-section td {
            width: 50%;
        }
        .header-section .right-details td {
            width: 50%;
            border: none;
            padding: 0;
        }
        .header-section .right-details td div {
            padding: 8px;
            border-left: 1px solid #000;
            border-top: 1px solid #000;
            border-right: 1px solid #000;
            border-bottom: none;
        }
        .header-section .right-details tr:last-child td div {
            border-bottom: 1px solid #000;
        }
        .section-title {
            font-weight: bold;
            font-size: 16px;
        }
        .align-right {
            text-align: right;
        }
        .align-center {
            text-align: center;
        }
        .items-table-header th {
            text-align: center;
            background-color: #f2f2f2;
        }
        .total-amount-row td {
            font-weight: bold;
        }
        .declaration-section {
            margin-top: 20px;
            border: 1px solid #000;
            padding: 10px;
            position: relative;
        }
        input[type="text"], input[type="date"], textarea {
            width: 100%;
            box-sizing: border-box;
            border: none;
            text-align: inherit;
            background: transparent;
            font-family: inherit;
            font-size: inherit;
        }
        input[type="date"] {
            font-family: Arial, sans-serif;
            font-size: 16px; 
            font-weight: bold;
        }
        .less-label {
            height: 120px;
            position: relative;
        }
        .less-tax-details {
            padding: 0;
        }
        .add-remove-btn-container {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }
        .add-remove-btn-container button {
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
        }
        textarea.buyer-input {
            resize: none; 
            overflow: hidden;
            line-height: 1.4;
        }
        .buyer-input[readonly], textarea.buyer-input[readonly] {
            border: none;
            background-color: white;
            cursor: default;
            padding-left: 2px;
        }
        .transport-input {
            width: 95%;
            border: none;
            background: transparent;
            border-bottom: 1px dashed #ccc;
            font-weight: bold;
            padding: 1px 0;
        }
        .transport-input:focus {
             outline: none;
             border-bottom: 1px solid #007bff;
        }
        .main-header {
            display: flex;
            justify-content: center; /* Changed from space-between */
            align-items: center;
            padding: 0 10px;
        }
        #i1{
            margin: 0; /* Removed margins */
            padding-bottom: 10px; /* Added some padding for spacing */
            flex-grow: 1;
            text-align: center;
        }
        .action-buttons {
            text-align: center;
            margin-top: 20px;
        }
        .action-buttons button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 0 10px;
            cursor: pointer;
            border-radius: 5px;
            border: none;
            color: white;
        }
        #addClientBtn {
            background-color: #007bff;
        }
        #viewBtn {
            background-color: #17a2b8;
        }
        #downloadBtn {
            background-color: #28a745;
        }
    </style>
</head>
<body>

<div class="invoice-wrapper">
    <div class="invoice-container" id="invoiceToPrint">
        <div class="main-header">
            <h2 id="i1">TAX INVOICE</h2>
        </div>
        <table class="header-section">
            <tr>
                <td rowspan="2" style="width: 50%; border-bottom: none; border-right: none;">
                    <div>
                        <span class="section-title">Swastik Metal </span><br>
                        Shop NO. 01  Surat<br>
                        GSTIN : 2400002KJDJSN55 <br>
                        Address :  Gujarat <br>
                        State : GUJARAT <br> Code: 24
                    </div>
                </td>
                <td style="border: none; padding: 0;">
                    <table class="right-details">
                        <tr>
                            <td style="width: 50%;  border: none;">
                                  <div>Invoice No.<br>
                                    <span class="section-title">
                                        <input type="text" id="invoiceNumberInput" placeholder="Invoice No." style="width: 100%; text-align:center; font-weight: bold; font-size: 16px;">
                                    </span>
                                  </div>
                            </td>
                            <td style="width: 50%; border-bottom: none;">
                                <div>Dated<br><input type="date" id="invoiceDate" style="text-align: center;"></div>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
            <tr>
                <td style="padding: 0;">
                    <table class="right-details">
                        <tr>
                            <td>
                                <div>
                                    Vehicle No.<br>
                                    <input type="text" class="transport-input" placeholder="">
                                    <br>
                                    Dispatched through<br>
                                    <input type="text" class="transport-input" placeholder="">
                                </div>
                            </td>
                            <td>
                                <div>
                                    Destination<br>
                                    <input type="text" class="transport-input" placeholder="">
                                    <br>
                                    Delivery Note Date<br>
                                    <input type="text" class="transport-input" placeholder="">
                                </div>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
    
        <table class="buyer-seller-section">
            <tr>
                <td style="width: 50%; border-bottom: none;">
                    <div id="shipToSection">
                        <b>Consignee (Ship to)</b><br>
                        <input type="text" id="shipToName" class="buyer-input section-title" readonly style="width: 100%; margin-bottom: 2px; ">
                        <textarea id="shipToAddress" class="buyer-input" readonly style="width: 100%; margin-bottom: 2px;" rows="1"></textarea>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <label for="shipToGst" style="white-space: nowrap;">GSTIN/UIN:&nbsp;</label>
                            <input type="text" id="shipToGst" placeholder="Enter GST No" style="flex-grow: 1; border: none; outline: none; padding: 2px 0px;  padding-left: 4px;">
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px; margin-top: 2px;">
                             <label for="shipToState" style="white-space: nowrap;">State:&nbsp;</label>
                             <input type="text" id="shipToState" class="buyer-input" readonly style="flex-grow: 1;">
                             <label for="shipToCode" style="white-space: nowrap;">Code:&nbsp;</label>
                             <input type="text" id="shipToCode" class="buyer-input" readonly style="width: 40px;">
                        </div>
                    </div>
                </td>
                <td style="width: 50%; border-bottom: none; border-top: none;">
                    <div id="billToSection">
                        <b>Buyer (Bill to)</b><br>
                        <input type="text" id="billToName" class="buyer-input section-title" readonly style="width: 100%; margin-bottom: 2px;">
                        <textarea id="billToAddress" class="buyer-input" readonly style="width: 100%; margin-bottom: 2px;" rows="1"></textarea>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <label for="billToGst" style="white-space: nowrap;">GSTIN/UIN:&nbsp;</label>
                            <input type="text" id="billToGst" class="buyer-input" readonly style="flex-grow: 1;">
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px; margin-top: 2px;">
                             <label for="billToState" style="white-space: nowrap;">State:&nbsp;</label>
                             <input type="text" id="billToState" class="buyer-input" readonly style="flex-grow: 1;">
                             <label for="billToCode" style="white-space: nowrap;">Code:&nbsp;</label>
                             <input type="text" id="billToCode" class="buyer-input" readonly style="width: 40px;">
                        </div>
                    </div>
                </td>
            </tr>
        </table>
        
        <table id="invoiceTable">
            <thead>
                <tr class="items-table-header">
                    <th rowspan="2" style="width: 5%;">Sl No</th>
                    <th rowspan="2" colspan="2" style="width: 30%;">Description of Goods</th>
                    <th rowspan="2" style="width: 15%;">HSN/SAC</th>
                    <th rowspan="2" style="width: 15%;">Quantity</th>
                    <th rowspan="2" style="width: 10%;">Rate</th>
                    <th rowspan="2" style="width: 5%;">per</th>
                    <th rowspan="2" style="width: 20%;">Amount</th>
                </tr>
                <tr></tr>
            </thead>
            <tbody id="invoiceTableBody">
                <tr class="item-row">
                    <td class="align-center">1</td>
                    <td colspan="2"><input type="text" class="description-input"></td>
                    <td class="align-center"><input type="text" class="hsn-input"></td>
                    <td class="align-right">
                        <input type="text" class="quantity-input" value="">
                    </td>
                    <td class="align-right">
                        <input type="text" class="rate-input" value="">
                    </td>
                    <td class="align-center"><input type="text" class="per-input"></td>
                    <td class="align-right amount-cell">0.00</td>
                </tr>
            </tbody>
            <tfoot id="invoiceTableFoot">
                <tr>
                    <td colspan="4" class="less-label" style="border-bottom: 1px solid #000;">
                        <div class="add-remove-btn-container">
                            <button id="addRowBtn">Add Item</button>
                            <button id="removeRowBtn">Remove</button>
                        </div>
                    </td>
                    <td colspan="4" class="less-tax-details" style="padding:0; border-bottom: 1px solid #000;">
                         <table style="width: 100%; border-collapse: collapse; ">
                             <tbody>
                                 <tr>
                                     <td colspan="2" class="align-right" style="border: none; border-bottom: 1px solid black; font-weight: bold; padding: 8px;" id="totalTaxableValue">0.00</td>
                                 </tr>
                                 <tr>
                                     <td class="align-right" style="border: none; padding: 8px 8px 4px 8px; width: 50%;">CGST 9%</td>
                                     <td class="align-right" style="border: none; padding: 8px 8px 4px 8px;" id="outputCGST">0.00</td>
                                 </tr>
                                 <tr>
                                     <td class="align-right" style="border: none; padding: 4px 8px;">SGST 9%</td>
                                     <td class="align-right" style="border: none; padding: 4px 8px;" id="outputSGST">0.00</td>
                                 </tr>
                                 <tr>
                                     <td class="align-right" style="border: none; padding: 4px 8px 8px 8px;">Round Off</td>
                                     <td class="align-right" style="border: none; padding: 4px 8px 8px 8px;" id="roundOff">0.00</td>
                                 </tr>
                             </tbody>
                         </table>
                    </td>
                </tr>
    
                <tr class="total-amount-row">
                    <td colspan="4" class="align-right">Total</td>
                    <td class="align-right" id="totalQuantity">0.00 KGS</td>
                    <td colspan="2"></td>
                    <td class="align-right" id="grandTotal">₹ 0.00</td>
                </tr>
    
                <tr>
                    <td colspan="8">
                        <div id="amountInWords">
                            <span class="section-title">Amount Chargeable (in words)</span><br>
                            Zero Only
                        </div>
                    </td>
                </tr>
    
                <tr class="items-table-header">
                    <th rowspan="2">HSN/SAC</th>
                    <th rowspan="2" colspan="2">Taxable Value</th>
                    <th colspan="2">CGST</th>
                    <th colspan="2">SGST</th>
                    <th rowspan="2">Total Tax Amount</th>
                </tr>
                <tr class="items-table-header">
                    <th>Rate</th>
                    <th>Amount</th>
                    <th>Rate</th>
                    <th>Amount</th>
                </tr>
                <tr>
                    <td class="align-center" id="taxHsnCode"></td>
                    <td colspan="2" class="align-right" id="taxableValue2">0.00</td>
                    <td class="align-center">9%</td>
                    <td class="align-right" id="cgstAmount">0.00</td>
                    <td class="align-center">9%</td>
                    <td class="align-right" id="sgstAmount">0.00</td>
                    <td class="align-right" id="totalTaxAmount">0.00</td>
                </tr>
                <tr class="total-amount-row">
                    <td colspan="3" class="align-right">Total</td>
                    <td colspan="2" class="align-right" id="totalCGSTAmount">0.00</td>
                    <td colspan="2" class="align-right" id="totalSGSTAmount">0.00</td>
                    <td class="align-right" id="totalTaxAmount2">0.00</td>
                </tr>
                 <tr>
                    <td colspan="8" style="font-weight: bold; ">
                        <div id="taxAmountInWords">Tax Amount (in words): Zero Only</div>
                    </td>
                </tr>
                <tr>
                    <td colspan="8" class="declaration-section">
                        <div>
                                <b>Company's Bank Details</b><br> 
                                Bank Name : <b>Your Bank Name</b><br>
                                A/c No.   : <b>1234569875</b><br>
                                Branch    : <b>Your Branch</b><br>
                                IFSC Code : <b>YOURCODE123</b>
                            </div>
                        
    
                        <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-top: 30px;">
                            <div >
                            <b>Declaration</b><br>
                            <p>We declare that this invoice shows the actual price of the goods <br> described and that all particulars are true and correct.</p>
                        </div>
                            <div style="text-align: right; padding-bottom: 10px;">
                                  <b>For Swastik Metal</b><br><br><br><br><br>
                                  Authorised Signatory
                            </div>
                        </div>
                        </td>
                </tr>
            </tfoot>
        </table>
        <h5 style="text-align: center ; margin-top: 10px;">This is a Computer Gererated Invoice</h3>
    </div>
    
    <div class="action-buttons">
        <button id="addClientBtn">Go To Dashboard</button>
        <button id="viewBtn">View Invoice</button>
        <button id="downloadBtn">Download PDF</button>
      
    </div>
</div>

<script>
    // ⚠️ IMPORTANT: Paste your Web App URL from Google Apps Script here
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyQbdXtyxMmZovlkjk97jYsnYx5MqQ_NtJgrdwaj-bCP-47wWbIFkP3m5pnQ4a_eC6L/exec";

    // Make jsPDF available globally
    const { jsPDF } = window.jspdf;

    async function saveAndDownloadPDF() {
        const downloadBtn = document.getElementById('downloadBtn');
        downloadBtn.disabled = true;
        downloadBtn.innerText = 'Saving...';

        console.log("PDF generation and saving process started...");
        const invoiceElement = document.getElementById('invoiceToPrint');
        const invoiceNumber = document.getElementById('invoiceNumberInput').value || 'invoice';
        const clientName = document.getElementById('billToName').value || 'N/A';

        // 1. Temporarily hide elements
        const addRemoveContainer = invoiceElement.querySelector('.add-remove-btn-container');
        addRemoveContainer.style.display = 'none';
        invoiceElement.style.filter = 'grayscale(100%)';

        try {
            // 2. Configure html2canvas for high quality
            const canvas = await html2canvas(invoiceElement, {
                scale: 3,
                useCORS: true,
                logging: true,
                letterRendering: true,
            });

            // 3. Create PDF object
            const imageData = canvas.toDataURL('image/jpeg', 1.0);
            const pdf = new jsPDF('p', 'pt', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const ratio = canvas.width / canvas.height;
            let imageWidth = pdfWidth - 40;
            let imageHeight = imageWidth / ratio;
            if (imageHeight > pdfHeight - 40) {
                imageHeight = pdfHeight - 40;
                imageWidth = imageHeight * ratio;
            }
            const x = (pdfWidth - imageWidth) / 2;
            const y = 20;
            pdf.addImage(imageData, 'JPEG', x, y, imageWidth, imageHeight);
            
            // 4. Get PDF data as Base64 string
            const pdfBase64 = pdf.output('datauristring');
            
            // 5. Create payload to send to Google Apps Script
            const payload = {
                action: 'saveInvoice',
                pdfData: pdfBase64,
                fileName: `${invoiceNumber}.pdf`,
                invoiceNo: invoiceNumber,
                clientName: clientName
            };
            
            // 6. Send the data to Google Apps Script
            console.log("Sending data to Google Apps Script...");
            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload),
            });

            const result = await response.json();

            if (result.status === 'success') {
                console.log("Successfully saved to Google Drive:", result.url);
                alert("Invoice successfully saved to Google Drive!");
                // 7. Finally, trigger the download for the user
                pdf.save(`${invoiceNumber}.pdf`);
            } else {
                throw new Error(result.message);
            }

        } catch (error) {
            console.error("An error occurred:", error);
            alert("Error saving invoice: " + error.message);
        } finally {
            // 8. Restore the hidden elements and button state
            addRemoveContainer.style.display = 'flex';
            invoiceElement.style.filter = 'none';
            downloadBtn.disabled = false;
            downloadBtn.innerText = 'Save & Download PDF';
            console.log("Process finished.");
        }
    }

    // --- All your original calculation and form logic below ---
    
    //
    // --- START OF THE FIX ---
    //
    // This new function will fetch clients from Google Sheets and store them in the browser.
    async function fetchAndStoreClients() {
        console.log("Fetching latest client data...");
        try {
            // We use the 'getClients' action from your Apps Script
            const response = await fetch(`${APPS_SCRIPT_URL}?action=getClients`);
            const result = await response.json();

            if (result.status === 'success') {
                // Store the data in localStorage so the GST input can find it
                localStorage.setItem('clientData', JSON.stringify(result.data));
                console.log("Client data successfully fetched and stored in localStorage.");
            } else {
                console.error("Failed to fetch client data:", result.message);
                alert("Could not load client data. Auto-fill might not work for new clients.");
            }
        } catch (error) {
            console.error("Error fetching clients:", error);
            alert("An error occurred while loading client data.");
        }
    }
    //
    // --- END OF THE FIX ---
    //

    document.addEventListener('DOMContentLoaded', () => {
        // Run the new function to get the latest client list when the page loads
        fetchAndStoreClients();

        document.getElementById('addClientBtn').addEventListener('click', () => {
            window.open('index.html', '_blank'); // Changed from manage-clients.html to open dashboard
        });
        document.getElementById('viewBtn').addEventListener('click', () => window.print());
        // 'downloadBtn' click now calls the new 'saveAndDownloadPDF' function
        document.getElementById('downloadBtn').addEventListener('click', saveAndDownloadPDF);
        document.getElementById('downloadBtn').innerText = 'Save & Download PDF'; // Update button text
        
        document.getElementById('addRowBtn').addEventListener('click', addRow);
        document.getElementById('removeRowBtn').addEventListener('click', removeRow);
        document.getElementById('invoiceDate').valueAsDate = new Date();
        const shipToGstInput = document.getElementById('shipToGst');
        
        shipToGstInput.addEventListener('input', () => {
            const gstToFind = shipToGstInput.value.trim().toUpperCase();
            // This line now correctly reads the data saved by fetchAndStoreClients()
            const allClients = JSON.parse(localStorage.getItem('clientData')) || {};
            const clientData = allClients[gstToFind];
            if (clientData) {
                fillDetails(clientData);
            } else {
                clearDetails();
            }
        });
        
        document.querySelectorAll('#invoiceTableBody .item-row input').forEach(input => {
            input.addEventListener('input', calculateInvoice);
            input.addEventListener('focus', function() { this.select(); });
        });
        calculateInvoice();
    });
    
    const taxRate = 0.09;
    let itemCounter = 1;
    function autoGrowTextarea(element) {
        element.style.height = "auto";
        element.style.height = (element.scrollHeight) + "px";
    }
    function fillDetails(data) {
        document.getElementById('shipToName').value = data.name;
        document.getElementById('shipToAddress').value = data.address;
        document.getElementById('shipToState').value = data.state;
        document.getElementById('shipToCode').value = data.code;
        document.getElementById('billToName').value = data.name;
        document.getElementById('billToAddress').value = data.address;
        document.getElementById('billToGst').value = data.gst;
        document.getElementById('billToState').value = data.state;
        document.getElementById('billToCode').value = data.code;
        autoGrowTextarea(document.getElementById('shipToAddress'));
        autoGrowTextarea(document.getElementById('billToAddress'));
    }
    function clearDetails() {
        document.getElementById('shipToName').value = '';
        document.getElementById('shipToAddress').value = '';
        document.getElementById('shipToState').value = '';
        document.getElementById('shipToCode').value = '';
        document.getElementById('billToName').value = '';
        document.getElementById('billToAddress').value = '';
        document.getElementById('billToGst').value = '';
        document.getElementById('billToState').value = '';
        document.getElementById('billToCode').value = '';
        autoGrowTextarea(document.getElementById('shipToAddress'));
        autoGrowTextarea(document.getElementById('billToAddress'));
    }
    function formatNumber(num) {
        if (isNaN(num) || !isFinite(num)) return '0.00';
        return num.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function sanitizeInput(input) {
        return parseFloat(String(input).replace(/,/g, '').replace(/[^\d.-]/g, '')) || 0;
    }
    function convertAmountToWords(amount) {
        if (amount === 0) return 'Zero Only';
        amount = Math.round(amount);
        const units = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
        const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
        const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
        const thousands = ['', 'Thousand', 'Lakh', 'Crore'];
        function toWords(num) {
            if (num === 0) return '';
            if (num < 10) return units[num];
            if (num < 20) return teens[num - 10];
            return tens[Math.floor(num / 10)] + (num % 10 !== 0 ? ' ' + units[num % 10] : '');
        }
        let words = '';
        let num = amount;
        let i = 0;
        if (num === 0) return 'Zero';
        while (num > 0) {
            let chunk;
            if (i === 0) {
                chunk = num % 1000;
                if(chunk !== 0){
                    let hundreds = Math.floor(chunk / 100);
                    let rest = chunk % 100;
                    let part = '';
                    if(hundreds > 0){ part += units[hundreds] + ' Hundred'; }
                    if(rest > 0){ part += (part ? ' ' : '') + toWords(rest); }
                    words = part + ' ' + thousands[i] + ' ' + words;
                }
                num = Math.floor(num / 1000);
            } else {
                chunk = num % 100;
                if(chunk !== 0){ words = toWords(chunk) + ' ' + thousands[i] + ' ' + words; }
                num = Math.floor(num / 100);
            }
            i++;
        }
        return 'INR ' + words.trim() + ' Only';
    }
    function calculateInvoice() {
        let totalTaxableValue = 0;
        let totalQuantity = 0;
        document.querySelectorAll('.item-row').forEach(row => {
            const quantity = sanitizeInput(row.querySelector('.quantity-input').value);
            const rate = sanitizeInput(row.querySelector('.rate-input').value);
            const amountCell = row.querySelector('.amount-cell');
            const amount = quantity * rate;
            amountCell.innerText = formatNumber(amount);
            totalTaxableValue += amount;
            totalQuantity += quantity;
        });
        const cgst = totalTaxableValue * taxRate;
        const sgst = totalTaxableValue * taxRate;
        document.getElementById('totalTaxableValue').innerText = formatNumber(totalTaxableValue);
        document.getElementById('taxableValue2').innerText = formatNumber(totalTaxableValue);
        document.getElementById('outputCGST').innerText = formatNumber(cgst);
        document.getElementById('outputSGST').innerText = formatNumber(sgst);
        document.getElementById('cgstAmount').innerText = formatNumber(cgst);
        document.getElementById('sgstAmount').innerText = formatNumber(sgst);
        document.getElementById('totalCGSTAmount').innerText = formatNumber(cgst);
        document.getElementById('totalSGSTAmount').innerText = formatNumber(sgst);
        const totalTaxAmount = cgst + sgst;
        document.getElementById('totalTaxAmount').innerText = formatNumber(totalTaxAmount);
        document.getElementById('totalTaxAmount2').innerText = formatNumber(totalTaxAmount);
        document.getElementById('taxAmountInWords').innerHTML = `<b>Tax Amount (in words):</b> ${convertAmountToWords(totalTaxAmount)}`;
        const grandTotalWithoutRounding = totalTaxableValue + totalTaxAmount;
        const roundedGrandTotal = Math.round(grandTotalWithoutRounding);
        const roundOff = roundedGrandTotal - grandTotalWithoutRounding;
        document.getElementById('roundOff').innerText = formatNumber(roundOff);
        document.getElementById('grandTotal').innerText = `₹ ${formatNumber(roundedGrandTotal)}`;
        document.getElementById('totalQuantity').innerText = `${formatNumber(totalQuantity)} KGS`;
        document.getElementById('amountInWords').innerHTML = `<span class="section-title">Amount Chargeable (in words)</span><br>${convertAmountToWords(roundedGrandTotal)}`;
        updateHsnCode();
    }
    function updateHsnCode() {
        const hsnInputs = document.querySelectorAll('.hsn-input');
        const firstHsnCode = hsnInputs.length > 0 ? hsnInputs[0].value : '';
        document.getElementById('taxHsnCode').innerText = firstHsnCode;
    }
    function addRow() {
        const tableBody = document.getElementById('invoiceTableBody');
        const newRow = document.createElement('tr');
        newRow.className = 'item-row';
        itemCounter++;
        newRow.innerHTML = `
            <td class="align-center">${itemCounter}</td>
            <td colspan="2"><input type="text" class="description-input"></td>
            <td class="align-center"><input type="text" class="hsn-input"></td>
            <td class="align-right"><input type="text" class="quantity-input" value=""></td>
            <td class="align-right"><input type="text" class="rate-input" value=""></td>
            <td class="align-center"><input type="text" class="per-input"></td>
            <td class="align-right amount-cell">0.00</td>
        `;
        tableBody.appendChild(newRow);
        newRow.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', calculateInvoice);
            input.addEventListener('focus', function() { this.select(); });
        });
        calculateInvoice();
    }
    function removeRow() {
        const tableBody = document.getElementById('invoiceTableBody');
        const rows = tableBody.querySelectorAll('.item-row');
        if (rows.length > 1) {
            tableBody.removeChild(rows[rows.length - 1]);
            itemCounter--;
            calculateInvoice();
        } else {
            alert("At least one item row is required.");
        }
    }
</script>

</body>
</html>
